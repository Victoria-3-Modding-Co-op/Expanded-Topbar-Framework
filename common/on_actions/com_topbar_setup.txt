# Setup on game start
on_game_started_after_lobby = {
	on_actions = {
		com_topbar_setup
	}
}

# Setup on game start
com_topbar_setup = {
	effect = {
		# Adding base game elements
		#= Prestige
		add_com_topbar_element = {
			element_name = com_topbar_element_prestige
		}
		#= Power Bloc Prestige
		add_com_topbar_element = {
			element_name = com_topbar_element_bloc_prestige
		}
		#= Power Bloc Cohesion
		add_com_topbar_element = {
			element_name = com_topbar_element_bloc_cohesion
		}
		#= Power Bloc Size
		add_com_topbar_element = {
			element_name = com_topbar_element_bloc_size
		}
		#= Legitimacy
		add_com_topbar_element = {
			element_name = com_topbar_element_legitimacy
		}
		#= Innovation
		add_com_topbar_element = {
			element_name = com_topbar_element_innovation
		}
		#= Companies
		add_com_topbar_element = {
			element_name = com_topbar_element_companies
		}
		#= Charters
		add_com_topbar_element = {
			element_name = com_topbar_element_charters
		}
		#= Army Size
		add_com_topbar_element = {
			element_name = com_topbar_element_army_size
		}
		#= Navy Size
		add_com_topbar_element = {
			element_name = com_topbar_element_navy_size
		}
		#= Interests
		add_com_topbar_element = {
			element_name = com_topbar_element_interests
		}
		#= Unemployed
		add_com_topbar_element = {
			element_name = com_topbar_element_unemployed_pops
		}
		#= Subsistence
		add_com_topbar_element = {
			element_name = com_topbar_element_subsistence_pops
		}
		#= Unrealized Taxes
		add_com_topbar_element = {
			element_name = com_topbar_element_unrealized_taxes
		}

		# Setting up a default topbar
		every_country = {
			# Calculate subsistence pops once for all countries
			com_topbar_calculate_subsistence_pops = yes

			add_to_variable_list = {
				name = com_topbar_first_line
				target = scope:com_topbar_element_prestige
			}
			add_to_variable_list = {
				name = com_topbar_first_line
				target = scope:com_topbar_element_legitimacy
			}
			add_to_variable_list = {
				name = com_topbar_first_line
				target = scope:com_topbar_element_innovation
			}
			add_to_variable_list = {
				name = com_topbar_first_line
				target = scope:com_topbar_element_companies
			}
			add_to_variable_list = {
				name = com_topbar_first_line
				target = scope:com_topbar_element_interests
			}
			add_to_variable_list = {
				name = com_topbar_first_line
				target = scope:com_topbar_element_army_size
			}
			add_to_variable_list = {
				name = com_topbar_first_line
				target = scope:com_topbar_element_navy_size
			}
		}
	}
}

# Adding base game elements if they are missing
on_half_yearly_pulse = {
	on_actions = {
		com_topbar_save_game_compatibility
		com_topbar_calculations
	}
}

# Adding base game elements if they are missing
com_topbar_save_game_compatibility = {
	trigger = {
		NOR = {
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_prestige
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_bloc_prestige
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_bloc_cohesion
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_prestige
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_prestige
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_prestige
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_prestige
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_prestige
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_prestige
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_bloc_size
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_legitimacy
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_innovation
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_companies
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_charters
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_army_size
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_navy_size
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_interests
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_unemployed_pops
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_subsistence_pops
			}
			any_in_global_list = {
				variable = com_topbar_items
				var:com_name ?= flag:com_topbar_element_unrealized_taxes
			}
		}
	}
	effect = {
		#= Prestige
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_prestige
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_prestige
			}
			every_country = {
				add_to_variable_list = {
					name = com_topbar_first_line
					target = scope:com_topbar_element_prestige
				}
			}
		}
		#= Power Bloc Prestige
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_bloc_prestige
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_bloc_prestige
			}
		}
		#= Power Bloc Cohesion
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_bloc_cohesion
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_bloc_cohesion
			}
		}
		#= Power Bloc Size
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_bloc_size
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_bloc_size
			}
		}
		#= Legitimacy
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_legitimacy
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_legitimacy
			}
			every_country = {
				add_to_variable_list = {
					name = com_topbar_first_line
					target = scope:com_topbar_element_legitimacy
				}
			}
		}
		#= Innovation
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_innovation
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_innovation
			}
			every_country = {
				add_to_variable_list = {
					name = com_topbar_first_line
					target = scope:com_topbar_element_innovation
				}
			}
		}
		#= Companies
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_companies
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_companies
			}
		}
		#= Charters
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_charters
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_charters
			}
		}
		#= Army Size
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_army_size
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_army_size
			}
			every_country = {
				add_to_variable_list = {
					name = com_topbar_first_line
					target = scope:com_topbar_element_army_size
				}
			}
		}
		#= Navy Size
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_navy_size
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_navy_size
			}
			every_country = {
				add_to_variable_list = {
					name = com_topbar_first_line
					target = scope:com_topbar_element_navy_size
				}
			}
		}
		#= Interests
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_interests
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_interests
			}
			every_country = {
				add_to_variable_list = {
					name = com_topbar_first_line
					target = scope:com_topbar_element_interests
				}
			}
		}
		#= Unemployed
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_unemployed_pops
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_unemployed_pops
			}
		}
		#= Subsistence
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_subsistence_pops
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_subsistence_pops
			}
		}
		#= Unrealized Taxes
		if = {
			limit = {
				NOT = {
					any_in_global_list = {
						variable = com_topbar_items
						var:com_name ?= flag:com_topbar_element_unrealized_taxes
					}
				}
			}
			add_com_topbar_element = {
				element_name = com_topbar_element_unrealized_taxes
			}
		}
	}
}

com_topbar_calculations = {
	effect = {
		every_country = {
			limit = {
				# We only need to do it for player countries
				is_player = yes
			}
			com_topbar_calculate_subsistence_pops = yes
		}
	}
}